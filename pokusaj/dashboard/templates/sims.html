<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SIM Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial; padding:20px; background:#f4f4f4;}
.chart-container{
    width:100%;
    max-height:250px;
    background:#fff;
    padding-bottom:40px!important;
    border:1px solid #ccc;
    border-radius:5px;
    box-sizing: border-box;
    display:flex;
    justify-content:center;
    align-items:center;
}
table{width:100%;border-collapse:collapse;background:white;margin-top:20px;}
th,td{padding:8px;border-bottom:1px solid #ccc; vertical-align:top;}
th{background:#eee;cursor:pointer;}
#syncBox{padding:10px; background:#fff; border:1px solid #ccc; margin-bottom:20px;}
#progressBar{height:20px; width:0%; background:#4caf50;}
button {padding:5px 10px; cursor:pointer;}
button:disabled {background:#ccc; cursor:default;}
#statusFilter {padding:5px; margin-left:10px;}

#simModal {display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.5); justify-content:center; align-items:center;}
#simModalContent {background:white; padding:20px; max-width:800px; width:90%; max-height:85%; overflow:auto;
    border-radius:5px; position:relative;}
#modalClose {position:absolute; top:10px; right:15px; cursor:pointer; font-size:20px;}

td table {border-collapse: collapse; width:100%;}
td table td, td table th {
    border:1px solid #ccc;
    padding:4px;
    font-size:13px;
}
td table th { background:#eee; }
</style>
</head>
<body>

<h1>üì° SIM Dashboard</h1>

<!-- SYNC STATUS -->
<div id="syncBox">
<h3>Status uƒçitavanja:</h3>
<div id="syncText">Uƒçitavanje...</div>
<div style="width:100%;background:#eee;height:20px;margin-top:10px;">
<div id="progressBar"></div>
</div>
</div>

<!-- CHARTOVI -->
<div style="display:flex; gap:20px; flex-wrap:wrap; padding-bottom:20px;">

  <div class="chart-container" style="flex:1 1 30%; flex-direction: column; padding:15px; box-sizing:border-box; max-width:none;">
    <h3 style="text-align:center;">Status SIM kartica</h3>
    <canvas id="statusChart"></canvas>
  </div>
  <div class="chart-container" style="flex:2 1 48%; flex-direction: column; padding:15px; box-sizing:border-box; max-width:none;">
    <h3 style="text-align:center;">Trend a≈æuriranja SIM kartica</h3>
    <canvas id="trendChart"></canvas>
  </div>
</div>

<h2>SIM Kartice</h2>

<label for="statusFilter">Filter po statusu:</label>
<select id="statusFilter" onchange="applyStatusFilter()">
    <option value="all">Svi statusi</option>
</select>

<!-- TABLICA SIMOVA -->
<table id="simTable">
<thead>
<tr>
<th onclick="sortTable(0)">ICCID</th>
<th onclick="sortTable(1)">MSISDN</th>
<th onclick="sortTable(2)">Status</th>
<th onclick="sortTable(3)">Label</th>
<th onclick="sortTable(4)">A≈æurirano</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div id="pagination" style="margin-top:10px;"></div>

<!-- MODAL -->
<div id="simModal">
    <div id="simModalContent">
        <span id="modalClose">&times;</span>
        <h3>Detalji SIM kartice</h3>
        <div id="modalContent"></div>
    </div>
</div>

<script>
let simsData = [];
let filteredData = [];
let currentPage = 1;
const rowsPerPage = 20;

// =========================================================
// REKURZIVNO PRETVARANJE JSON ‚Üí TABLICE
// =========================================================
function generateJsonTable(data) {

    function buildTable(obj) {
        let html = `<table style="width:100%; margin:5px 0;">`;
        html += `<thead>
                  <tr>
                      <th style="padding:5px; background:#eee;">Kljuƒç</th>
                      <th style="padding:5px; background:#eee;">Vrijednost</th>
                  </tr>
                 </thead><tbody>`;

        if (Array.isArray(obj)) {
            obj.forEach((value, index) => {
                html += `
                    <tr>
                        <td style="padding:5px; font-weight:bold;">${index}</td>
                        <td style="padding:5px;">${formatValue(value)}</td>
                    </tr>`;
            });
        }
        else if (typeof obj === 'object' && obj !== null) {
            for (let key in obj) {
                const value = obj[key];
                html += `
                    <tr>
                        <td style="padding:5px; font-weight:bold;">${key}</td>
                        <td style="padding:5px;">${formatValue(value)}</td>
                    </tr>`;
            }
        }

        html += "</tbody></table>";
        return html;
    }

    function formatValue(value) {
        if (value === null) return "<i>null</i>";
        if (typeof value === "string") return value.replace(/\n/g, "<br>");
        if (typeof value === "number" || typeof value === "boolean") return value;
        if (typeof value === "object") return buildTable(value);
        return String(value);
    }

    return buildTable(data);
}

// =========================================================
// MODAL
// =========================================================
function showSimDetails(sim){
    const modal = document.getElementById("simModal");
    const content = document.getElementById("modalContent");

    let raw = {};
    try { raw = JSON.parse(sim.raw_json); } catch(e){ raw = {}; }

    content.innerHTML = `
<b>ICCID:</b> ${sim.iccid}<br>
<b>MSISDN:</b> ${sim.msisdn_primary || ""}<br>
<b>Status:</b> ${sim.status || ""}<br>
<b>Label:</b> ${sim.label || ""}<br>
<b>Opis:</b> ${sim.description || ""}<br>
<b>A≈æurirano:</b> ${sim.updated_at}<br><br>

<h3>Raw JSON</h3>
${generateJsonTable(raw)}
`;

    modal.style.display = "flex";
}

document.getElementById("modalClose").addEventListener("click", () =>
    document.getElementById("simModal").style.display = "none"
);

window.addEventListener("click", e => {
    if(e.target === document.getElementById("simModal")){
        document.getElementById("simModal").style.display = "none";
    }
});

// =========================================================
// FETCH SIM LISTE + FILTERI + PAGINATION
// =========================================================
function loadTable(){
    fetch("/api/sims").then(r => r.json()).then(data => {
        simsData = data;
        filteredData = data.slice();
        populateStatusFilter();
        currentPage = 1;
        displayFilteredPage();
    });
}

function populateStatusFilter(){
    const select = document.getElementById("statusFilter");
    select.innerHTML = '<option value="all">Svi statusi</option>';
    const statuses = [...new Set(simsData.map(sim => sim.status).filter(s => s))];
    statuses.forEach(s => {
        select.innerHTML += `<option value="${s}">${s}</option>`;
    });
}

function applyStatusFilter(){
    const s = document.getElementById("statusFilter").value;
    filteredData = (s === "all") ? simsData.slice() : simsData.filter(sim => sim.status === s);
    currentPage = 1;
    displayFilteredPage();
}

function displayFilteredPage(){
    const tbody = document.querySelector("#simTable tbody");
    tbody.innerHTML = "";

    const start = (currentPage - 1) * rowsPerPage;
    const pageItems = filteredData.slice(start, start + rowsPerPage);

    pageItems.forEach(sim => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${sim.iccid}</td>
            <td>${sim.msisdn_primary || ""}</td>
            <td>${sim.status || ""}</td>
            <td>${sim.label || ""}</td>
            <td>${sim.updated_at}</td>
        `;
        tr.addEventListener("click", () => showSimDetails(sim));
        tbody.appendChild(tr);
    });

    setupPagination();
}

function setupPagination(){
    const pageCount = Math.ceil(filteredData.length / rowsPerPage);
    const div = document.getElementById("pagination");
    div.innerHTML = "";

    div.innerHTML += `<button onclick="prevPage()" ${currentPage===1?'disabled':''}>Prev</button>`;
    div.innerHTML += ` <b>Stranica ${currentPage} od ${pageCount}</b> `;
    div.innerHTML += `<button onclick="nextPage()" ${currentPage===pageCount?'disabled':''}>Next</button>`;
}

function prevPage(){ if(currentPage>1){ currentPage--; displayFilteredPage(); } }
function nextPage(){
    const max = Math.ceil(filteredData.length / rowsPerPage);
    if(currentPage < max){ currentPage++; displayFilteredPage(); }
}

// =========================================================
// SYNC STATUS
// =========================================================
function loadSyncStatus(){
    fetch("/api/sync-status").then(r=>r.json()).then(status=>{
        const text=document.getElementById("syncText");
        const bar=document.getElementById("progressBar");

        if(status.running){
            let cur=status.current_page;
            let tot=status.total_pages || (cur+1);
            let pc=Math.min(100,(cur/tot)*100);
            text.innerHTML=`Uƒçitavanje SIM kartica... stranica ${cur} od ${tot}`;
            bar.style.width=pc+"%";
        } else {
            bar.style.width="100%";
            text.innerHTML=`Zadnji sync: ${status.last_sync}<br>
                             Sljedeƒái sync: ${status.next_sync ? new Date(status.next_sync*1000).toLocaleTimeString() : "N/A"}`;
        }
    });
}

// =========================================================
// CHARTOVI
// =========================================================
function loadStatusChart(){
    fetch("/api/status-stats").then(r=>r.json()).then(data=>{
        new Chart(document.getElementById("statusChart"),{ type:"pie",
            data:{ labels:data.labels, datasets:[{ data:data.counts,
            backgroundColor:["#4caf50","#ff9800","#f44336","#2196f3","#9c27b0"] }] },
            options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{ position:'right' } } } });
    });
}

function loadTrendChart(){
    fetch("/api/update-trend").then(r=>r.json()).then(data=>{
        new Chart(document.getElementById("trendChart"),{ type:"line",
            data:{ labels:data.labels, datasets:[{ label:"A≈æuriranja", data:data.counts,
            borderColor:"#2196f3", fill:false }] },
            options:{ responsive:true, maintainAspectRatio:true } });
    });
}

// =========================================================
// INIT
// =========================================================
loadTable();
loadStatusChart();
loadTrendChart();
loadSyncStatus();

setInterval(loadTable,300000);
setInterval(loadSyncStatus,20000);
</script>

</body>
</html>
